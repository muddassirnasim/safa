name: Deploy WordPress Theme to SVN

on:
  push:
    tags:
      - "v*"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install SVN
        run: sudo apt-get install subversion

      - name: Export theme files (ignore dev files)
        run: |
          mkdir export
          rsync -r --exclude='.git*' --exclude='.github' --exclude='node_modules' \
                --exclude='webpack.config.js' --exclude='package*.json' \
                --exclude='.distignore' --exclude='.env' \
                ./ export/

      - name: Checkout SVN repo
        run: |
          svn checkout https://themes.svn.wordpress.org/safa svn-wp \
            --username "${{ secrets.SVN_USERNAME }}" \
            --password "${{ secrets.SVN_PASSWORD }}" \
            --non-interactive

      - name: Create tags folder if missing
        run: |
          mkdir -p svn-wp/tags
          svn add svn-wp/tags || true
          cd svn-wp
          svn commit -m "Create tags directory" \
            --username "${{ secrets.SVN_USERNAME }}" \
            --password "${{ secrets.SVN_PASSWORD }}" \
            --non-interactive || true

      - name: Copy to versioned tag directory
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          mkdir -p svn-wp/tags/$VERSION
          cp -R export/* svn-wp/tags/$VERSION/

      - name: Commit versioned tag to SVN
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          cd svn-wp
          svn add --force tags/$VERSION
          svn commit -m "Deploy version $VERSION" \
            --username "${{ secrets.SVN_USERNAME }}" \
            --password "${{ secrets.SVN_PASSWORD }}" \
            --non-interactive
