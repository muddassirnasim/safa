name: Deploy WordPress Theme to SVN

on:
  push:
    tags:
      - "v*"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install SVN
        run: sudo apt-get install subversion

      - name: Export theme files (ignore dev files)
        run: |
          mkdir export
          rsync -av --exclude-from=".distignore" ./ export/

      - name: Checkout SVN repo
        run: |
          svn checkout "https://themes.svn.wordpress.org/safa/" svn-wp
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}

      - name: Replace trunk with export (safe create)
        run: |
          mkdir -p svn-wp/trunk
          rm -rf svn-wp/trunk/*
          cp -R export/* svn-wp/trunk/

      - name: Commit trunk to SVN
        run: |
          cd svn-wp
          svn add --force trunk
          svn commit -m "Deploy new theme version" --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --no-auth-cache

      - name: Tag SVN version
        run: |
          cd svn-wp
          svn cp trunk tags/${GITHUB_REF_NAME} --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --no-auth-cache
          svn commit -m "Tagging version ${GITHUB_REF_NAME}" --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --no-auth-cache
