name: Deploy WordPress Theme to SVN

on:
  push:
    tags:
      - "v*"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install SVN
        run: sudo apt-get install subversion

      - name: Export theme files (ignore dev files)
        run: |
          mkdir export
          rsync -av --exclude-from=".distignore" ./ export/

      - name: Checkout SVN repo
        run: |
          svn checkout https://themes.svn.wordpress.org/safa/ svn-wp --username "${{ secrets.SVN_USERNAME }}" --password "${{ secrets.SVN_PASSWORD }}" --non-interactive

      - name: Replace trunk with export (safe create)
        run: |
          rm -rf svn-wp/trunk
          mkdir svn-wp/trunk
          cp -R export/* svn-wp/trunk/

      - name: Commit trunk to SVN
        run: |
          cd svn-wp
          svn add --force trunk
          svn commit -m "Deploy new theme version" \
            --username "${{ secrets.SVN_USERNAME }}" \
            --password "${{ secrets.SVN_PASSWORD }}" \
            --non-interactive

      - name: Tag SVN version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          svn cp https://themes.svn.wordpress.org/safa/trunk \
            https://themes.svn.wordpress.org/safa/tags/$VERSION \
            -m "Tagging version $VERSION" \
            --username "${{ secrets.SVN_USERNAME }}" \
            --password "${{ secrets.SVN_PASSWORD }}" \
            --non-interactive
